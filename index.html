<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAPRO - AI í•™ìŠµ ë°ì´í„°ìš©</title>
    <style>
        body { font-family: 'Pretendard', -apple-system, sans-serif; display: flex; margin: 0; height: 100vh; background: #f5f5f5; color: #333; }
        .editor { width: 50%; padding: 30px; overflow-y: auto; border-right: 2px solid #ddd; background: #fff; box-sizing: border-box; }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-top: 0; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.9em; color: #555; }
        
        .tag-row { display: flex; gap: 8px; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .tag-input { flex: 1; border: none; border-bottom: 2px solid #ddd; background: transparent; padding: 5px; font-size: 0.9em; outline: none; transition: 0.3s; }
        .tag-input:focus { border-bottom-color: #4a90e2; }
        
        .hashtag { display: inline-block; background: #eef5ff; color: #4a90e2; padding: 4px 10px; border-radius: 15px; font-size: 0.85em; font-weight: bold; margin-right: 5px; margin-bottom: 10px; }
        .hashtag::before { content: "#"; }

        .search-container { padding: 15px; background: #fff; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; }
        .search-bar { width: 100%; padding: 10px 15px; border: 2px solid #4a90e2; border-radius: 25px; outline: none; font-size: 0.9em; box-sizing: border-box; }

        .type-selector { display: flex; gap: 8px; margin-bottom: 15px; }
        .type-btn { flex: 1; padding: 12px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .type-btn.active { background: #4a90e2; color: white; border-color: #4a90e2; }

        textarea, input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        
        /* ì„ íƒì§€ ìŠ¤íƒ€ì¼ ê°œì„  */
        .option-wrapper { background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; padding: 10px; margin-bottom: 10px; }
        .option-main { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .option-main span { font-weight: bold; width: 25px; }
        .opt-exp { width: 100%; padding: 8px; border: 1px dashed #ccc; background: #fff; font-size: 0.9em; color: #666; margin-top: 5px; margin-left: 35px; width: calc(100% - 35px); box-sizing: border-box; }
        .opt-exp:focus { border-color: #4a90e2; background: #fff; color: #333; }

        /* ë©”ëª¨ì¥ ìŠ¤íƒ€ì¼ */
        .memo-area { background: #fff9db; border: 1px solid #e6dbb9; color: #555; }

        .btn-save { background: #4a90e2; color: white; width: 100%; padding: 15px; margin: 15px 0; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: #ff4d4d; color: white; width: 100%; padding: 10px; margin-bottom: 15px; border: none; border-radius: 4px; cursor: pointer; display: none; }
        .action-btns { display: flex; gap: 10px; }
        .btn-secondary { background: #eee; color: #333; flex: 1; padding: 10px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; }

        .preview-container { width: 50%; display: flex; flex-direction: column; background: #fafafa; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; background: #fff; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #999; }
        .tab.active { color: #4a90e2; border-bottom: 3px solid #4a90e2; background: #fff; }
        .tab-content { flex: 1; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }
        .content-padding { padding: 30px; }

        .question-card { background: white; padding: 35px; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; margin-bottom: 20px; }
        .box-preview { border: 1px solid #333; padding: 15px; margin: 15px 0; background: #fff; position: relative; white-space: pre-wrap; }
        .box-preview::before { content: "<ë³´ ê¸°>"; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; font-size: 0.9em; font-weight: bold; }
        .preview-img { max-width: 100%; margin: 15px 0; border-radius: 4px; }
        .card-controls { position: absolute; top: 15px; right: 15px; display: flex; gap: 5px; }
        .control-btn { cursor: pointer; background: #f0f0f0; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; color: #555; }

        /* ë¯¸ë¦¬ë³´ê¸°ì—ì„œì˜ í•´ì„¤/ë©”ëª¨ ìŠ¤íƒ€ì¼ */
        .preview-exp { font-size: 0.85em; color: #666; margin-left: 20px; margin-top: 2px; display: block; background: #f1f1f1; padding: 4px 8px; border-radius: 4px; width: fit-content; }
        .preview-memo { margin-top: 20px; padding: 15px; background: #fffbe6; border-left: 4px solid #ffd700; font-size: 0.9em; color: #555; white-space: pre-wrap; }
        .preview-memo strong { display: block; margin-bottom: 5px; color: #d4a017; }
    </style>
</head>
<body>

<div class="editor">
    <h2 id="editor-title">MAPRO í¸ì§‘ê¸°</h2>
    
    <div class="tag-row">
        <input type="text" id="subject" class="tag-input" placeholder="ê³¼ëª©ëª…">
        <input type="text" id="year" class="tag-input" placeholder="ì—°ë„">
        <input type="text" id="month" class="tag-input" placeholder="ì›”">
        <input type="text" id="q-number" class="tag-input" placeholder="ë²ˆí˜¸">
    </div>

    <div class="input-group">
        <label>ë¬¸ì œ ìœ í˜• ì„ íƒ</label>
        <div class="type-selector">
            <button class="type-btn active" id="btn-multiple" onclick="setMainType('multiple')">ì˜¤ì§€ì„ ë‹¤í˜•</button>
            <button class="type-btn" id="btn-short" onclick="setMainType('short')">ë‹¨ë‹µí˜•</button>
        </div>
        <div id="box-option-toggle" style="margin-top: 10px;">
            <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                <input type="checkbox" id="use-box" onchange="toggleBoxInput()"> <span style="margin-left: 8px;">ë³´ê¸°(ë°•ìŠ¤) ì¶”ê°€í•˜ê¸°</span>
            </label>
        </div>
    </div>

    <div class="input-group">
        <label>ë¬¸ì œ ì§€ë¬¸</label>
        <textarea id="question-text" rows="3" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
    </div>
    <div id="box-input-area" class="input-group" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <label style="margin-bottom: 0;">ë³´ê¸° ë°•ìŠ¤ ë‚´ìš©</label>
        <button class="btn-shuffle" onclick="shuffleBoxContent()">ğŸ”€ ë¬¸í•­ ìˆœì„œ ì„ê¸°</button>
    </div>
    <textarea id="box-content" rows="4" placeholder="ã„±. ë‚´ìš©&#10;ã„´. ë‚´ìš©"></textarea>
</div>
    <div id="box-input-area" class="input-group" style="display: none;">
        <label>ë³´ê¸° ë°•ìŠ¤ ë‚´ìš© (ã„±, ã„´, ã„·...)</label>
        <textarea id="box-content" rows="4" placeholder="ã„±. ë‚´ìš©&#10;ã„´. ë‚´ìš©"></textarea>
    </div>

    <div class="input-group">
        <label>ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ)</label>
        <input type="file" id="image-input" accept="image/*">
    </div>

    <div id="options-area" class="input-group">
        <label>ì„ íƒì§€ ë° í•´ì„¤(ê·¼ê±°) ì‘ì„±</label>
        <div class="options">
            <div class="option-wrapper">
                <div class="option-main">
                    <input type="radio" name="correct" value="0"> <span>â‘ </span>
                    <input type="text" class="opt" placeholder="ë³´ê¸° 1 ë‚´ìš©">
                </div>
                <input type="text" class="opt-exp" placeholder="â”” â‘ ë²ˆ ì„ íƒì§€ì— ëŒ€í•œ í•´ì„¤/ê·¼ê±° (AI í•™ìŠµìš© ë°ì´í„°)">
            </div>
            <div class="option-wrapper">
                <div class="option-main">
                    <input type="radio" name="correct" value="1"> <span>â‘¡</span>
                    <input type="text" class="opt" placeholder="ë³´ê¸° 2 ë‚´ìš©">
                </div>
                <input type="text" class="opt-exp" placeholder="â”” â‘¡ë²ˆ ì„ íƒì§€ì— ëŒ€í•œ í•´ì„¤/ê·¼ê±°">
            </div>
            <div class="option-wrapper">
                <div class="option-main">
                    <input type="radio" name="correct" value="2"> <span>â‘¢</span>
                    <input type="text" class="opt" placeholder="ë³´ê¸° 3 ë‚´ìš©">
                </div>
                <input type="text" class="opt-exp" placeholder="â”” â‘¢ë²ˆ ì„ íƒì§€ì— ëŒ€í•œ í•´ì„¤/ê·¼ê±°">
            </div>
            <div class="option-wrapper">
                <div class="option-main">
                    <input type="radio" name="correct" value="3"> <span>â‘£</span>
                    <input type="text" class="opt" placeholder="ë³´ê¸° 4 ë‚´ìš©">
                </div>
                <input type="text" class="opt-exp" placeholder="â”” â‘£ë²ˆ ì„ íƒì§€ì— ëŒ€í•œ í•´ì„¤/ê·¼ê±°">
            </div>
            <div class="option-wrapper">
                <div class="option-main">
                    <input type="radio" name="correct" value="4"> <span>â‘¤</span>
                    <input type="text" class="opt" placeholder="ë³´ê¸° 5 ë‚´ìš©">
                </div>
                <input type="text" class="opt-exp" placeholder="â”” â‘¤ë²ˆ ì„ íƒì§€ì— ëŒ€í•œ í•´ì„¤/ê·¼ê±°">
            </div>
        </div>
    </div>

    <div id="short-input-area" class="input-group" style="display: none;">
        <label>ë‹¨ë‹µí˜• ì •ë‹µ</label>
        <input type="text" id="short-answer" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”.">
    </div>

    <div class="input-group">
        <label>ğŸ“ ì„ ìƒë‹˜ ë©”ëª¨ (ì¶œì œ ì˜ë„ / ì „ì²´ í•´ì„¤)</label>
        <textarea id="teacher-memo" class="memo-area" rows="3" placeholder="ì´ ë¬¸ì œì˜ í•µì‹¬ í¬ì¸íŠ¸ë‚˜ ì „ì²´ì ì¸ í•´ì„¤ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
    </div>

    <button id="btn-save" class="btn-save" onclick="saveQuestion()">+ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ê¸°</button>
    <button id="btn-cancel" class="btn-cancel" onclick="cancelEdit()">ìˆ˜ì • ì·¨ì†Œ</button>

    <div class="action-btns">
        <button class="btn-secondary" onclick="downloadJSON()">JSON ì €ì¥ (AIìš©)</button>
        <button class="btn-secondary" onclick="document.getElementById('file-loader').click()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
    <input type="file" id="file-loader" style="display:none" onchange="loadJSON(event)">
</div>

<div class="preview-container">
    <div class="tabs">
        <div id="t-live" class="tab active" onclick="switchTab('live')">ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</div>
        <div id="t-list" class="tab" onclick="switchTab('list')">ì „ì²´ ë¦¬ìŠ¤íŠ¸ (<span id="q-count">0</span>)</div>
    </div>

    <div id="tab-live" class="tab-content active">
        <div class="content-padding">
            <div class="question-card">
                <div id="p-tags"></div>
                <div id="p-question" style="font-size: 1.1em; font-weight: bold; white-space: pre-wrap;">ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
                <img id="p-image" class="preview-img" style="display: none;">
                <div id="p-box" class="box-preview" style="display:none;"></div>
                
                <div id="p-options-area" style="margin-top:15px;"><ul id="p-options" style="list-style:none; padding:0;"></ul></div>
                <div id="p-short-area" style="display:none; margin-top:15px; padding:10px; background:#f0f0f0; border-radius:4px;"><strong>ì •ë‹µ:</strong> <span id="p-short-ans"></span></div>
                
                <div id="p-memo" class="preview-memo" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div id="tab-list" class="tab-content">
        <div class="search-container">
            <input type="text" id="search-input" class="search-bar" placeholder="ê³¼ëª©, ì—°ë„, ë‚´ìš©, ë©”ëª¨ ê²€ìƒ‰..." oninput="renderList()">
        </div>
        <div id="question-list" class="content-padding"></div>
    </div>
</div>

<script>
    let questions = [];
    let currentMainType = 'multiple'; 
    let currentImage = "";
    let editingId = null;
    const fields = ['subject', 'year', 'month', 'q-number'];

    function setMainType(type) {
        currentMainType = type;
        document.getElementById('btn-multiple').classList.toggle('active', type === 'multiple');
        document.getElementById('btn-short').classList.toggle('active', type === 'short');
        document.getElementById('box-option-toggle').style.display = (type === 'multiple' ? 'block' : 'none');
        document.getElementById('options-area').style.display = (type === 'multiple' ? 'block' : 'none');
        document.getElementById('short-input-area').style.display = (type === 'short' ? 'block' : 'none');
        if(type === 'short') { document.getElementById('use-box').checked = false; toggleBoxInput(); }
        updatePreview();
    }

    function toggleBoxInput() {
        const useBox = document.getElementById('use-box').checked;
        document.getElementById('box-input-area').style.display = useBox ? 'block' : 'none';
        updatePreview();
    }

    function switchTab(tab) {
        document.getElementById('t-live').classList.toggle('active', tab === 'live');
        document.getElementById('t-list').classList.toggle('active', tab === 'list');
        document.getElementById('tab-live').classList.toggle('active', tab === 'live');
        document.getElementById('tab-list').classList.toggle('active', tab === 'list');
        if(tab==='list') renderList();
    }

    function updatePreview() {
        // íƒœê·¸
        const pTags = document.getElementById('p-tags');
        pTags.innerHTML = '';
        fields.forEach(f => {
            const val = document.getElementById(f).value;
            if(val) {
                const span = document.createElement('span');
                span.className = 'hashtag';
                span.innerText = val;
                pTags.appendChild(span);
            }
        });
        
        document.getElementById('p-question').innerText = document.getElementById('question-text').value || "ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        
        // ë°•ìŠ¤
        const useBox = document.getElementById('use-box').checked;
        const pBox = document.getElementById('p-box');
        if(currentMainType === 'multiple' && useBox && document.getElementById('box-content').value) {
            pBox.innerText = document.getElementById('box-content').value;
            pBox.style.display = 'block';
        } else { pBox.style.display = 'none'; }

        // ì˜µì…˜ ë° í•´ì„¤
        if(currentMainType === 'multiple') {
            document.getElementById('p-options-area').style.display = 'block';
            document.getElementById('p-short-area').style.display = 'none';
            const pOptions = document.getElementById('p-options');
            const correctIdx = Array.from(document.querySelectorAll('input[name="correct"]')).find(r => r.checked)?.value;
            
            pOptions.innerHTML = '';
            const opts = document.querySelectorAll('.opt');
            const exps = document.querySelectorAll('.opt-exp');
            
            opts.forEach((input, i) => {
                const li = document.createElement('li');
                li.style.marginBottom = '10px';
                
                let optText = input.value || 'ì„ íƒì§€ ' + (i+1);
                let expText = exps[i].value; // í•´ì„¤ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°

                let html = `<div style="${correctIdx == i ? 'color:#4a90e2; font-weight:bold;' : ''}">${['â‘ ','â‘¡','â‘¢','â‘£','â‘¤'][i]} ${optText}</div>`;
                
                if(expText) {
                    html += `<span class="preview-exp">â”” ${expText}</span>`;
                }
                
                li.innerHTML = html;
                pOptions.appendChild(li);
            });
        } else {
            document.getElementById('p-options-area').style.display = 'none';
            document.getElementById('p-short-area').style.display = 'block';
            document.getElementById('p-short-ans').innerText = document.getElementById('short-answer').value || "ë¯¸ì…ë ¥";
        }

        // ë©”ëª¨
        const memoVal = document.getElementById('teacher-memo').value;
        const pMemo = document.getElementById('p-memo');
        if(memoVal) {
            pMemo.innerHTML = `<strong>ğŸ“ ì„ ìƒë‹˜ ë©”ëª¨</strong>${memoVal}`;
            pMemo.style.display = "block";
        } else {
            pMemo.style.display = "none";
        }
    }

    document.getElementById('image-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                currentImage = ev.target.result;
                document.getElementById('p-image').src = currentImage;
                document.getElementById('p-image').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

function shuffleBoxContent() {
    const boxArea = document.getElementById('box-content');
    const content = boxArea.value.trim();
    if (!content) return;

    const linesOriginal = content.split('\n').filter(l => l.trim().length > 0);
    
    // 1. ê¸°í˜¸ ì²´ê³„ ê°ì§€ (ì²« ì¤„ì´ ê¸°í˜¸ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸)
    const firstLine = linesOriginal[0];
    const labelMatch = firstLine.match(/^([ã„±-ã…a-zA-Z0-9])[\.\)]/);
    
    let linesToShuffle = [];
    let currentLabels = null;

    if (labelMatch) {
        // [ì¼€ì´ìŠ¤ A] ê¸°í˜¸ê°€ ìˆëŠ” ê²½ìš°: ê¸°í˜¸ ë–¼ê³  ë‚´ìš©ë§Œ ì¶”ì¶œ
        const firstChar = labelMatch[1];
        
        // ê¸°í˜¸ ì„¸íŠ¸ ê²°ì •
        if (/[ã„±-ã…]/.test(firstChar)) currentLabels = ['ã„±', 'ã„´', 'ã„·', 'ã„¹', 'ã…', 'ã…‚'];
        else if (/[a-z]/.test(firstChar)) currentLabels = ['a', 'b', 'c', 'd', 'e', 'f'];
        else if (/[A-Z]/.test(firstChar)) currentLabels = ['A', 'B', 'C', 'D', 'E', 'F'];
        else if (/[0-9]/.test(firstChar)) currentLabels = ['1', '2', '3', '4', '5', '6'];

        linesToShuffle = linesOriginal.map(line => line.replace(/^[ã„±-ã…a-zA-Z0-9][\.\)]\s*/, "").trim());
    } else {
        // [ì¼€ì´ìŠ¤ B] ê¸°í˜¸ê°€ ì—†ëŠ” ì¤„ê¸€ì¸ ê²½ìš°: ì¤„ ë‹¨ìœ„ë¡œ ì „ì²´ ì¶”ì¶œ
        linesToShuffle = linesOriginal.map(line => line.trim());
    }

    // 2. ì„ê¸° (Fisher-Yates)
    for (let i = linesToShuffle.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [linesToShuffle[i], linesToShuffle[j]] = [linesToShuffle[j], linesToShuffle[i]];
    }

    // 3. ì¬ì¡°í•©
    if (currentLabels) {
        // ê¸°í˜¸ê°€ ìˆì—ˆë˜ ê²½ìš° ë‹¤ì‹œ ê¸°í˜¸ë¥¼ ë¶™ì—¬ì¤Œ
        boxArea.value = linesToShuffle.map((line, idx) => `${currentLabels[idx]}. ${line}`).join('\n');
    } else {
        // ì¤„ê¸€ì´ì—ˆë˜ ê²½ìš° ì„ì¸ ë¬¸ì¥ë“¤ë§Œ ë‹¤ì‹œ í•©ì¹¨
        boxArea.value = linesToShuffle.join('\n');
    }
    
    updatePreview();
}
    function fillForm(q) {
        document.getElementById('subject').value = q.tags.subject || '';
        document.getElementById('year').value = q.tags.year || '';
        document.getElementById('month').value = q.tags.month || '';
        document.getElementById('q-number').value = q.tags.number || '';
        setMainType(q.mainType);
        document.getElementById('question-text').value = q.text;
        document.getElementById('use-box').checked = q.useBox;
        toggleBoxInput();
        if(q.useBox) document.getElementById('box-content').value = q.boxContent;
        currentImage = q.image;
        if(q.image) {
            document.getElementById('p-image').src = q.image;
            document.getElementById('p-image').style.display = 'block';
        } else { document.getElementById('p-image').style.display = 'none'; }
        
        // ì˜µì…˜ ë° ê°œë³„ í•´ì„¤ ë³µêµ¬
        if(q.mainType === 'multiple') {
            q.options.forEach((val, i) => document.querySelectorAll('.opt')[i].value = val);
            // í•´ì„¤ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë³µêµ¬, ì—†ìœ¼ë©´ ë¹ˆê°’
            const expList = q.optionExplanations || ["","","","",""];
            expList.forEach((val, i) => document.querySelectorAll('.opt-exp')[i].value = val);

            if(q.correct !== undefined) document.querySelectorAll('input[name="correct"]')[q.correct].checked = true;
        } else { document.getElementById('short-answer').value = q.answer || ''; }

        // ë©”ëª¨ ë³µêµ¬
        document.getElementById('teacher-memo').value = q.memo || '';

        updatePreview();
    }

    function copyQuestion(id) {
        const q = questions.find(item => item.id === id);
        if(!q) return;
        editingId = null;
        document.getElementById('editor-title').innerText = "ë¬¸ì œ ë³µì‚¬ ì¤‘ (ìƒˆ ë¬¸ì œë¡œ ì €ì¥ë¨)";
        document.getElementById('btn-save').innerText = "+ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ê¸°";
        document.getElementById('btn-cancel').style.display = "block";
        fillForm(q);
        switchTab('live');
    }

    function editQuestion(id) {
        const q = questions.find(item => item.id === id);
        if(!q) return;
        editingId = id;
        document.getElementById('editor-title').innerText = "ë¬¸ì œ ìˆ˜ì • ì¤‘";
        document.getElementById('btn-save').innerText = "âœ… ìˆ˜ì • ì™„ë£Œ";
        document.getElementById('btn-cancel').style.display = "block";
        fillForm(q);
        switchTab('live');
    }

    function saveQuestion() {
        const text = document.getElementById('question-text').value.trim();
        if(!text) return alert("ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        
        let data = { 
            id: editingId || Date.now(), 
            mainType: currentMainType, 
            useBox: document.getElementById('use-box').checked, 
            text: text, 
            image: currentImage,
            memo: document.getElementById('teacher-memo').value, // ë©”ëª¨ ì €ì¥
            tags: {
                subject: document.getElementById('subject').value,
                year: document.getElementById('year').value,
                month: document.getElementById('month').value,
                number: document.getElementById('q-number').value
            }
        };

        if(data.useBox) data.boxContent = document.getElementById('box-content').value;
        
        if(currentMainType === 'multiple') {
            const opts = Array.from(document.querySelectorAll('.opt')).map(i => i.value.trim());
            const exps = Array.from(document.querySelectorAll('.opt-exp')).map(i => i.value.trim()); // ê°œë³„ í•´ì„¤ ì €ì¥

            const correct = Array.from(document.querySelectorAll('input[name="correct"]')).find(r => r.checked)?.value;
            if(opts.some(v => v === "")) return alert("5ì§€ì„ ë‹¤ë¥¼ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”.");
            if(correct === undefined) return alert("ì •ë‹µì„ ì²´í¬í•˜ì„¸ìš”.");
            
            data.options = opts; 
            data.optionExplanations = exps; // í•´ì„¤ ë°ì´í„° êµ¬ì¡°ì— ì¶”ê°€
            data.correct = correct;
        } else {
            const ans = document.getElementById('short-answer').value.trim();
            if(!ans) return alert("ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”.");
            data.answer = ans;
        }

        if(editingId) { questions[questions.findIndex(q => q.id === editingId)] = data; }
        else { questions.push(data); }
        document.getElementById('q-count').innerText = questions.length;
        resetForm(); updatePreview(); switchTab('list');
    }

    function resetForm() {
        editingId = null;
        document.getElementById('editor-title').innerText = "MAPRO í¸ì§‘ê¸°";
        document.getElementById('btn-save').innerText = "+ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ê¸°";
        document.getElementById('btn-cancel').style.display = "none";
        fields.forEach(f => document.getElementById(f).value = '');
        document.getElementById('question-text').value = '';
        document.getElementById('use-box').checked = false;
        toggleBoxInput();
        document.getElementById('box-content').value = '';
        document.getElementById('image-input').value = '';
        currentImage = '';
        document.getElementById('p-image').style.display = 'none';
        
        document.querySelectorAll('.opt').forEach(i => i.value = '');
        document.querySelectorAll('.opt-exp').forEach(i => i.value = ''); // í•´ì„¤ ì´ˆê¸°í™”

        document.querySelectorAll('input[name="correct"]').forEach(r => r.checked = false);
        document.getElementById('short-answer').value = '';
        document.getElementById('teacher-memo').value = ''; // ë©”ëª¨ ì´ˆê¸°í™”
    }

    function renderList() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const container = document.getElementById('question-list');
        
        const filtered = questions.filter(q => {
            const tagString = Object.values(q.tags).join(' ').toLowerCase();
            const contentString = q.text.toLowerCase();
            const memoString = (q.memo || "").toLowerCase(); // ë©”ëª¨ë„ ê²€ìƒ‰
            return tagString.includes(searchTerm) || contentString.includes(searchTerm) || memoString.includes(searchTerm);
        });

        container.innerHTML = filtered.length === 0 ? '<p style="text-align:center; color:#999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>' : '';
        
        filtered.forEach((q, idx) => {
            const card = document.createElement('div');
            card.className = 'question-card';
            const tagHtml = Object.values(q.tags).filter(v => v).map(v => `<span class="hashtag">${v}</span>`).join('');
            
            // ë¦¬ìŠ¤íŠ¸ ë·° ë Œë”ë§
            let optionsHtml = '';
            if(q.mainType === 'multiple') {
                optionsHtml = `<ul style="list-style:none; padding:0; margin-top:10px;">
                    ${q.options.map((o, i) => {
                        const exp = q.optionExplanations && q.optionExplanations[i] ? `<span class="preview-exp">â”” ${q.optionExplanations[i]}</span>` : '';
                        return `<li style="margin-bottom:8px; ${q.correct == i ? 'color:#4a90e2; font-weight:bold;' : ''}">
                                ${['â‘ ','â‘¡','â‘¢','â‘£','â‘¤'][i]} ${o} ${exp}
                                </li>`;
                    }).join('')}
                </ul>`;
            } else {
                optionsHtml = `<div style="margin-top:10px; padding:8px; background:#f0f0f0;"><strong>ì •ë‹µ:</strong> ${q.answer}</div>`;
            }

            const memoHtml = q.memo ? `<div class="preview-memo"><strong>ğŸ“ ì„ ìƒë‹˜ ë©”ëª¨</strong>${q.memo}</div>` : '';

            card.innerHTML = `
                <div class="card-controls">
                    <button class="control-btn" onclick="copyQuestion(${q.id})">ë³µì‚¬</button>
                    <button class="control-btn" onclick="editQuestion(${q.id})">ìˆ˜ì •</button>
                    <button class="control-btn" style="color:red;" onclick="removeQuestion(${q.id})">ì‚­ì œ</button>
                </div>
                <div style="margin-bottom:10px;">${tagHtml}</div>
                <div style="font-weight:bold; white-space:pre-wrap;">${q.text}</div>
                ${q.image ? `<img src="${q.image}" class="preview-img">` : ''}
                ${q.useBox ? `<div class="box-preview">${q.boxContent}</div>` : ''}
                
                ${optionsHtml}
                ${memoHtml}
            `;
            container.appendChild(card);
        });
    }

    function removeQuestion(id) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) { questions = questions.filter(q => q.id !== id); document.getElementById('q-count').innerText = questions.length; renderList(); } }
    function downloadJSON() { const blob = new Blob([JSON.stringify(questions, null, 2)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'asdf.json'; a.click(); }
    function loadJSON(e) { const reader = new FileReader(); reader.onload = (ev) => { questions = JSON.parse(ev.target.result); document.getElementById('q-count').innerText = questions.length; switchTab('list'); }; reader.readAsText(e.target.files[0]); }
    function cancelEdit() { resetForm(); updatePreview(); }

    fields.forEach(f => document.getElementById(f).addEventListener('input', updatePreview));
    document.getElementById('question-text').addEventListener('input', updatePreview);
    document.getElementById('box-content').addEventListener('input', updatePreview);
    document.getElementById('short-answer').addEventListener('input', updatePreview);
    document.getElementById('teacher-memo').addEventListener('input', updatePreview);
    document.addEventListener('input', function(e){
        if(e.target.classList.contains('opt') || e.target.classList.contains('opt-exp')) updatePreview();
    });
    document.querySelectorAll('input[name="correct"]').forEach(i => i.addEventListener('change', updatePreview));
</script>
</body>
</html>